!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Virtual=e()}(this,function(){"use strict";function n(e,t){var i,n=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)),n}function h(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach(function(t){o(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function o(t,e,i){return(e=function(t){t=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);i=i.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}(t,"string");return"symbol"==typeof t?t:String(t)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function r(t,e,i){window.addEventListener?t.addEventListener(e,i,!1):window.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i}function s(t,e,i){window.removeEventListener?t.removeEventListener(e,i,!1):window.detachEvent?t.detachEvent("on"+e,i):t["on"+e]=null}function l(e,i){function t(){var t=this;n=arguments,o||(i<=0?e.apply(t,n):o=setTimeout(function(){o=void 0,e.apply(t,n)},i))}var n,o=void 0;return t.cancel=function(){o&&(clearTimeout(o),o=void 0)},t}var c="forward",a="backward",t="horizontal",e="vertical",i=o(o({},e,"scrollTop"),t,"scrollLeft"),f=o(o({},e,"scrollHeight"),t,"scrollWidth"),u=o(o({},e,"offsetHeight"),t,"offsetWidth");function g(t,e){if(!t||!t.nodeType||1!==t.nodeType)throw"Virtual: `el` must be an HTMLElement, not ".concat({}.toString.call(t));this.el=t,this.options=e=Object.assign({},e);var i,n,o={scroller:null,itemCount:0,direction:"vertical",dataIndex:"data-index",ignoreSize:0,debounceTime:null,throttleTime:null};for(i in o)i in this.options||(this.options[i]=o[i]);for(n in this.sizes=[],this.range={start:0,end:0,front:0,behind:0,total:0},this.offset=0,this.lastStart=0,this.averageSize=0,this.scrollDirection="",this._updateOnScrollFunction(),this)"_"===n.charAt(0)&&"function"==typeof this[n]&&(this[n]=this[n].bind(this));this.scrollEl=this._getScrollElement(this.options.scroller),r(this.options.scroller,"scroll",this._onScroll),this._onCreate()}return g.prototype={constructor:g,destroy:function(){s(this.options.scroller,"scroll",this._onScroll),this.sizes=this.range=this.offset=this.lastStart=this.averageSize=null},refresh:function(){1<this.averageSize?this._onRefresh():this._onCreate()},option:function(t,e){if(void 0===e)return this.options[t];var i=this.options[t];this.options[t]=e,"itemCount"===t?this._onCreate():"scroller"===t?(s(i,"scroll",this._onScroll),this.scrollEl=this._getScrollElement(e),r(e,"scroll",this._onScroll)):"throttleTime"!==t&&"debounceTime"!==t||this._updateOnScrollFunction()},getSize:function(t){return this.sizes[t]||this.averageSize},getOffset:function(){return this.scrollEl[i[this.options.direction]]},getScrollSize:function(){return this.scrollEl[f[this.options.direction]]},getClientSize:function(){return this.scrollEl[u[this.options.direction]]},scrollToOffset:function(t){this.scrollEl[i[this.options.direction]]=t},scrollToIndex:function(t){t>this._getLength()?this.scrollToBottom():(t=this._getOffsetByRange(0,t),this.scrollToOffset(t+this.options.ignoreSize))},scrollToBottom:function(){var i=this,t=this.getScrollSize();this.scrollToOffset(t),setTimeout(function(){var t=i.getClientSize(),e=i.getScrollSize();i.getOffset()+t+1<e&&i.scrollToBottom()},5)},_updateOnScrollFunction:function(){var t,e,i,n=this;function o(){i.cancel(),i.apply(this,arguments)}this.options.debounceTime?this._onScroll=(t=function(){return n._onRefresh()},e=this.options.debounceTime,i=l(t,e),o.cancel=function(){i.cancel()},o):this.options.throttleTime?this._onScroll=l(function(){return n._onRefresh()},this.options.throttleTime):this._onScroll=function(){return n._onRefresh()}},_onCreate:function(){if(this._contentVisible()){var t=this._getRenderingItems();if(t.length){for(var e=this.getClientSize(),i=this.getOffset(),i=Math.abs(i-this.options.ignoreSize),n=this.range.start,o=Math.max(0,this.range.front-i);o<e&&n<this.options.itemCount;){var r=t[n-this.range.start];if(!r)break;var s=this._getItemIndex(r),r=this._getItemSize(r);o+=this.sizes[s]=r,n+=1}this.averageSize=Math.round((this.range.front+o)/n),this.sizes.length=this.options.itemCount,n=Math.min(this._getLength(),n+1),this._updateRange(h(h({},this.range),{},{end:n}))}}},_onRefresh:function(){var t,e,i;this.averageSize<1?this._onCreate():this._contentVisible()&&(t=this.getOffset(),e=this.getClientSize(),i=this.getScrollSize(),t<this.offset-1?this.scrollDirection=c:t>this.offset+1?this.scrollDirection=a:this.scrollDirection="",this.offset=t,this._dispatchEvent("onScroll",{top:!!this.options.itemCount&&t<=0,bottom:i<=e+t+1,offset:t,direction:this.scrollDirection}),!this.scrollDirection||this.scrollDirection===c&&0===this.range.start||this.scrollDirection===a&&this.range.end===this._getLength()||this._onUpdate())},_onUpdate:function(){for(var t=this._getRenderingItems(),e=0;e<t.length;e+=1){var i=this._getItemIndex(t[e]);i&&(this.sizes[i]=this._getItemSize(t[e]))}this.lastStart=this.range.start;var n=this._getRangeByOffset(),o=n.start,r=n.front,n=n.end;o===this.range.start&&n===this.range.end||this._updateRange({start:o,end:n,front:r})},_updateRange:function(t){var e=t.start,i=t.end,t=t.front,n=(this._getLength()-i)*this.averageSize,o=this._getOffsetByRange(e,i);this.range.start=e,this.range.front=t,this.range.end=i,this.range.behind=n,this.range.total=Math.max(this.range.total,t+o+n),this._dispatchEvent("onUpdate",h({},this.range))},_getRangeByOffset:function(){for(var t=this.options,e=t.itemCount,t=t.ignoreSize,i=this.getClientSize(),n=this.offset-t,o=0,r=0,s=0,h=0;s<e;){var l=this.getSize(s);if(n<=h+l){o=s,r=h;break}h+=l,s+=1}for(;s<e&&(h+=this.getSize(s),s+=1,!(i<h-r)););return this.averageSize=Math.round(h/s),s=Math.min(this._getLength(),s+1),h<n&&(o=s-Math.round(i/this.averageSize),r=this._getOffsetByRange(0,o)),{start:o,front:r,end:s}},_getOffsetByRange:function(t,e){for(var i=0,n=t;n<e;n+=1)i+=this.getSize(n);return i},_getLength:function(){return Math.max(0,this.options.itemCount-1)},_getItemSize:function(t){return t?t[u[this.options.direction]]:this.averageSize},_getItemIndex:function(t){return(null==t?void 0:t.getAttribute(this.options.dataIndex))||null},_getScrollElement:function(t){return t instanceof Document&&9===t.nodeType||t instanceof Window?document.scrollingElement||document.documentElement||document.body:t},_getRenderingItems:function(){return Array.prototype.slice.call(this.el.children)},_contentVisible:function(){return 0<this.el.offsetHeight&&0<this.el.offsetWidth},_dispatchEvent:function(t,e){t=this.options[t];"function"==typeof t&&t(e)}},g});
